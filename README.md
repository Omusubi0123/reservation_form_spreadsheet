# 観劇予約フォームシステム
（with Google Form, Google Spreadsheet, GAS）

GoogleフォームとGoogleスプレッドシートを使った観劇予約フォームシステムです．

## 作成手順
※プログラムはフォーム項目の順番，スプシのシート名に依存しているため，同一の順番で作成してください．  変更したい場合はプログラムの修正が必要です🙇‍♂️
1. Googleフォームを作成
    - [このフォーム](https://docs.google.com/forms/d/e/1FAIpQLScPAlKBT6gZzwkpSjzE9CfoxorkBzL9Xeh1m7tN74fxBZMZzw/viewform)を参考に，Googleフォームを作成します．
    - フォーム項目のタイトルは↑のフォームと同一にしていただくと，プログラムの修正が不要です．
    - 1セクション
        - メールアドレス
        - お名前（代表者）
        - 電話番号
        - ご所属
        - 予約の空き状況
            - 説明文がフォーム送信ごとに更新される
            - 空き状況：`〇：充分空きあり  △：残りわずか  ×：満席`
            - `▲`：残席数が`15%`未満の場合．残席数も表示される
        - 予約日時
            - フォーム送信ごとに，プルダウン選択肢が更新される
            - ↑のフォームでは4公演なので，4つの項目を作成
        - 予約人数
            - ラジオボタン，この人数-1個の項目を2セクションに配置
    - 2セクション
        - 同行者名入力（代表者を除く）
        - 同行者名1
        - 同行者名2
        - 同行者名3
        - 同行者名4
    <p align="center">
        <img src="material/form1.png" alt="1セクション" width="60%">
        <img src="material/form2.png" alt="2セクション" width="60%">
    </p>

2. Googleスプレッドシートを作成
    - 1で作成したGoogleフォームの回答が記録されるGoogleスプレッドシートを作成します．
    - 作成したスプレッドシートを1で作成したGoogleフォームに紐付けます．
    - 紐づけられたスプレッドシートのシート名は`予約状況`にしてください．
        - このシートにはフォーム送信ごとの回答が記録されます．
    - 公演の数だけ追加でシートを作成します．
        - シート名は`1ステ`，`2ステ`，`3ステ`，`4ステ`にしてください．
        - 各シートについて，フォーム項目のタイトルを記入します．  
            `メールアドレス,	お名前（代表者）,	電話番号,	予約日時,	ご所属,	人数,	同行者名1,	同行者名2,	同行者名3,	同行者名4`
        - 2行目以降に，各公演ごとの回答が記録されます．
    - `予約合計人数`シートを作成します．
        - 以下のようなフォーマットで記入します．
            ```
            ステ名	ステ時間	最大人数	予約人数	残席
            1ステ	5月4日(土) 12:40 ~ 15:10	98	0	98
            2ステ	5月4日(土) 17:50 ~ 20:20	98	0	98
            3ステ	5月5日(日) 10:00 ~ 12:30	98	0	98
            4ステ	5月5日(日) 14:40 ~ 17:10	105	0	105
            ```
        - フォームが送信されるごとに，予約人数に応じて残席数が更新されます．
        - 同時に，この残席数の情報を基に，フォームの予約日時のプルダウンの説明文・選択肢が更新されます．
        - 残席数が`15%`未満の場合，その公演の予約状況が`〇`から`▲(残席わずか)`に変更され，残席数が表示される
        - 残席数が`0`になると，`▲`から`×(満席)`に変更され，その公園の選択肢がフォームから削除される
    <p align="center">
        <img src="material/spreadsheet1.png" alt="予約状況シート" width="80%">
        <img src="material/spreadsheet2.png" alt="1ステシート" width="80%">
        <img src="material/spreadsheet3.png" alt="予約合計人数シート" width="80%">
    </p>

3. Google Apps Script（GAS）を作成
    - 2で作成したGoogleスプレッドシートに紐付けるGoogle Apps Scriptを作成します．
    - このリポジトリの`src/`の各ファイルをGASにコピペします．
        - このリポジトリでは`.js`としていますが，GAS上では`.gs`として保存してください．
        - GASでは同一プロジェクト内のすべてのファイルの内容を参照できるので，`fileA`で宣言した関数や変数を，`import`などを使わずに`fileB`で使うことができます．
        - よって，`src/`の全ファイルの内容を`main.gs`にまとめても構いません．
        - `form_submitted.js`がメインの処理を行うファイルです．
    - トリガーを設定します．
        - トリガーは，フォーム送信時に実行される関数を設定します．
        - トリガーは，GASのプロジェクト画面の左下にある時計マークをクリックし，トリガーを追加することで設定できます．
        - トリガーの設定は以下の通りです．
            - 【必須】`form_submitted`関数を実行する
                - 実行する関数：`form_submitted`
                - デプロイ：Head
                - イベントのソース：スプレッドシートから
                - イベントの種類：フォーム送信時
            - 【任意】`resend_email_check`関数を実行する
                - 実行する関数：`resend_email_check`
                - デプロイ：Head
                - イベントのソース：時間主導型
                - 時間ベースのトリガータイプを選択：分ベースのタイマー
                - 時間の間隔：1分おき or 5分おき
                - 予約受付開始直後などの大量の受付が来る時間には1分や5分おきに設定し，それ以外は1時間おきなどに設定すると良いです．
    - 各ファイルの内容は以下です．  
        ※各ファイルの変数で，各自の環境に合わせて変更する部分があるので変更してください
        - `form_submitted.js`
            - フォーム送信時の処理を行う
            - トリガーに設定される関数であり，メインの処理を行う
            - 予約成功に場合：
                - 予約成功の旨のメールを送信する
                - フォーム送信ごとに，予約合計人数シートの予約人数を更新し，残席数を計算する
                - 予約合計人数シートの残席数に応じて，予約状況シートの空き状況を更新する
                - 予約合計人数シートの残席数に応じて，予約日時のプルダウンの説明文・選択肢を更新する
            - 予約失敗の場合：
                - 予約失敗の旨のメールを送信する
            - 以下は各自の環境に合わせて変更すること
                ```
                // スプシの該当する列名と，予約成功可否の列インデックス(int)
                const RESERVE_STATUS_SHEETNAME = "予約状況";
                const RESERVE_SUCCESS_FAILURE_COLUMN_INDEX = 12
                ```
        - `send_email.js`
            - フォーム送信時に，予約者にメールを送信する
            - `form_submitted.js`で使用
            ※送信するためのメールアドレスは，スプシやGASを使用しているアカウントのものである必要がある
            - 以下は各自の環境に合わせて変更してください
                ```
                // スプシの該当する列名
                const MAIL_ADDRESS_COLUMN = "メールアドレス";
                const REPRESENTATIVE_NAME_COLUMN = "お名前（代表者）";
                
                // メールの内容
                const MUSICAL_TITLE = "【公演名】";
                const EMAIL_FROM = "【担当者のメールアドレス】"
                const MUSICAL_GROUP = "【公演団体名】";
                const MUSICAL_VENUE = "【公演会場】";
                const VENUE_ACCESS = "【会場アクセス】";
                ```
        - `update_stage_sheet.js`
            - 予約されたステのシートに予約者情報を追加
            - `form_submitted.js`で使用
        - `update_remaining_seats.js`
            - 予約されたステの予約合計人数を計算し，予約合計人数のシートの予約人数と残席を更新
            - `form_submitted.js`で使用
            - 以下は各自の環境に合わせて変更すること
                ```
                // スプシの予約合計人数のシート名と，予約状況シートにおける予約人数が書かれた列のインデックス
                const RESERVE_TOTAL_SHEETNAME = "予約合計人数";
                const PEOPLE_COUNT_COLUMN_INDEX = 6

                // スプシの予約合計人数シートにおける，ステの予約合計人数のインデックス
                const MAX_PEOPLE_NUM_INDEX = 3;
                const RESERVED_NUM_INDEX = 4;
                const LEFT_PEOPLE_NUM_INDEX = 5;
                ```
        - `update_stage_select_button.js`
            - 予約合計人数シートの残席数に応じて，予約日時のプルダウンの説明文・選択肢を更新する
            - `form_submitted.js`で使用
            - 以下は各自の環境に合わせて変更すること（※フォームIDを書き忘れないこと！！！）
                ```
                const FORM_ID = "1Og...KS4"; // 予約フォームのID 各自の環境に合わせて変更すること
                const DAYTIME_BUTTON_TITLE = "予約日時";
                const RESERVE_STATUS_HEADER = "予約の空き状況";
                const STAGE_DAYTIME = ["5月4日(土) 12:40 ~ 15:10", "5月4日(土) 17:50 ~ 20:20", "5月5日(日) 10:00 ~ 12:30", "5月5日(日) 14:40 ~ 17:10"]; // 予約可能なステの日（フォームと同一のものを記入すること）
                ```
        - `update_stage_infos.js`
            - 全ての公演シートについて，予約合計人数シートの残席数を更新する（フォームの更新は行わない）
            - 動作確認的な意味合いが強く，`form_submitted.js`での処理には含まれていない
            - 以下は各自の環境に合わせて変更すること
                ```
                const RESERVED_DAYTIME_COLUMN = "予約日時";
                const STAGE_1 = "1ステ";
                const STAGE_2 = "2ステ";
                const STAGE_3 = "3ステ";
                const STAGE_4 = "4ステ";
                const STAGE_NAME_DICT = {
                "5月4日(土) 12:40 ~ 15:10": STAGE_1,
                "5月4日(土) 17:50 ~ 20:20": STAGE_2,
                "5月5日(日) 10:00 ~ 12:30": STAGE_3,
                "5月5日(日) 14:40 ~ 17:10": STAGE_4
                };  // update_stage_select_button.jsと同一のものを記入すること
                ```
        - `assess_reservation.js`
            - 予約人数と残席数に矛盾がないか（予約が成功するか）判定
            - 矛盾なし-> true, 矛盾アリ -> false
            - `form_submitted.js`にて仕様
            - 以下は各自の環境に合わせて変更すること
                ```
                // スプシの該当する列名（フォーム項目と同一）
                const RESERVED_PEOPLE_COLUMN = "予約人数";
                ```
        - `check_email_send_result.js`
            - 未完成（このファイルは未使用なので，コピーしなくても問題ない）
            - メール送信の結果をチェックする
            - 不明なメールアドレスをチェックし，送信失敗メールを検知して再送信する
        - `resend_email_check.js`
            - フォーム提出後，数秒（約4秒）以内に次の提出がされるとトリガーが発動しないエラーへの対応
            - メール送信列に成功も失敗も書かれていない（空欄の）場合に，もう一度メールを送信する
            - 予約受付開始時に大量のフォームが送信され，対応しきれない場合（失敗した場合）に対応
            - これもトリガーとして設定しておくと安心

    <p align="center">
        <img src="material/gas1.png" alt="GAS", width="80%">
        <img src="material/gas2.png" alt="trigger", width="80%">
    </p>

## 注意点
GoogleフォームやGASの仕様上，いくつか不便な点があります．
- プログラムの変数に，フォームのIDやスプシを使用しているメールアドレスを記載する必要がある．
    - ここで設定した（GASが使用しているアカウントのメールアドレス）からメールが送信されることになる．
- 現状，「ふりがな」の入力欄がないので，ふりがなの入力を求める場合，その分スプシの列名やインデックスの調整が必要．
- スプシ「予約状況」シートにて，メール送信に成功失敗を記載する列が一番右に（デフォルトでは12列目）あり，これが未記載の行はメールの送信がなされていない
    - 短時間に大量のフォームが送信される場合，トリガーが発動しないエラーが発生することがある
    - その場合，`resend_email_check`関数をトリガーとして設定しておくと，未送信のメールを再送信することができる
- 